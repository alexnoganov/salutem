{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/EditingPatient.css' %}">
{% endblock %}
{% block title %}
    <title>Добавить пациента</title>
{% endblock %}
{% block content %}
    <div class="container" style="max-width: 700px">
        <div class="page_form">
            <form name="field" method="post" id="jjdd">
                {% csrf_token %}
                <div class="form__section">
                    <fieldset class="fieldset">
                        <legend class="fieldset__legend">Данные:</legend>
                        <div class="fieldset__row">
                            <div class="form-block">
                                <div>
                                    <label for="powermail_field_anrede" title="">
                                                                 <span class="input-field-wrapper__label">
                                                                     Пол
                                                                 </span>
                                    </label>
                                    <div class="select">
                                        {% render_field form.Sex class="select__control" id="powermail_field_anrede" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fieldset__row fieldset__row--col fieldset__row--col2">
                            <div class="form-block">
                                <div>
                                    <label for="powermail_field_vorname" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        <span>*</span>
                                                                        Имя
                                                                    </span>
                                    </label>
                                    {% render_field form.Name class="text-input powermail_input" id="powermail_field_vorname" placeholder="Александр" value=profile.Name %}
                                </div>
                                <div class="invalid-feedback" id="invalid_name"
                                     style="display: none">
                                    Это поле не может быть пустым или иметь не
                                    корректные значения.
                                </div>
                            </div>
                            <div class="form-block">
                                <div class="input-field-wrapper">
                                    <label for="powermail_field_nachname" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        <span>*</span>
                                                                        Фамилия
                                                                    </span>
                                        {% render_field form.Surname class="text-input powermail_input" id="powermail_field_nachname" placeholder="Белоусов" value=profile.Surname %}
                                    </label>
                                </div>
                                <div class="invalid-feedback" id="invalid_surname"
                                     style="display: none">
                                    Это поле не может быть пустым или иметь не
                                    корректные значения.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="form__section">
                    <fieldset class="fieldset">
                        <div class="fieldset__row fieldset__row--col fieldset__row--col2">
                            <div class="form-block">
                                <div>
                                    <label for="powermail_field_vorname" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        <span>*</span>
                                                                        Отчество
                                                                    </span>
                                    </label>
                                        {% render_field form.Patronymic class="text-input powermail_input" id="powermail_field_Patronymic" placeholder="Владиславович" value=profile.Patronymic %}
                                    <div class="invalid-feedback" id="invalid_patronymic"
                                         style="display: none">
                                        Это поле не может быть пустым или иметь не
                                        корректные значения.
                                    </div>
                                </div>
                            </div>
                            <div class="form-block">
                                <div class="input-field-wrapper">
                                    <label for="powermail_field_geburtsdatum" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        Дата рождения
                                                                    </span>
                                    </label>
                                    {% render_field form.Date_of_birth type="date" class="text-input powermail_input" id="powermail_field_geburtsdatum" placeholder="yyyy-mm-dd" value=profile.Date_of_birth %}
                                <div class="invalid-feedback" id="invalid_date"
                                         style="display: none">
                                        Это поле не может быть пустым или иметь не
                                        корректные значения.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="form__section">
                    <fieldset class="fieldset">
                        <div class="fieldset__row fieldset__row--col fieldset__row--col2">
                            <div class="form-block">
                                <div class="input-field-wrapper">
                                    <label for="powermail_field_telefonnummer" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        <span>*</span>
                                                                        Номер телефона
                                                                    </span>
                                    </label>
                                    {% render_field form.Telephone class="text-input powermail_input" id="powermail_field_telefonnummer" placeholder="012345678910" value=profile.Telephone %}
                                </div>
                                <div class="invalid-feedback" id="invalid_phone"
                                     style="display: none">
                                    Это поле не может быть пустым или иметь не
                                    корректные значения.
                                </div>
                            </div>
                            <div class="form-block">
                                <div class="input-field-wrapper">
                                    <label for="powermail_field_e_mail" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        <span>*</span>
                                                                        E-Mail
                                                                    </span>
                                    </label>
                                    {% render_field form.Email class="text-input powermail_input" id="powermail_field_e_mail" placeholder="mustermann@gmail.com" value=profile.Email %}
                                </div>
                                <div class="invalid-feedback" id="invalid_email"
                                     style="display: none">
                                    Введен некорректный адрес эл.почты.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="form__section">
                    <fieldset class="fieldset">
                        <div class="fieldset__row">
                            <div class="form-block">
                                <div class="input-field-wrapper">
                                    <label for="powermail_field_residence" title="">
                                                                    <span class="input-field-wrapper__label">
                                                                        Место проживания
                                                                    </span>
                                    </label>
                                    {% render_field form.Place_of_residence class="text-input powermail_input" id="powermail_field_residence" placeholder="м. Донецьк, пров. Шота Руставелі, 91" value=profile.Place_of_residence %}
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="form__section">
                    <fieldset class="fieldset">

                        <div class="fieldset__row">
                            <div class="form-block">
                                <div>
                                    <label for="powermail_field_blood" title="">
                                                                 <span class="input-field-wrapper__label">
                                                                     Группа крови
                                                                 </span>
                                    </label>
                                    {% if request.user.is_staff or not perms.user.edit_analyzes %}
                                        {% render_field form.Blood_type class="select__control" id="powermail_field_blood" %}
                                    {% else %}
                                        {% render_field form.Blood_type disabled='disabled' class="select__control" id="powermail_field_blood" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                    </fieldset>
                </div>
                <button type="submit" class="submit__form" id="add_patient">Добавить</button>
            </form>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        document.querySelector("#add_patient").addEventListener("click", (e) => {
            e.preventDefault();
            if (validator()) {
                $.ajax({
                    url: '/patients/add/patient',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        data: JSON.stringify({
                            pk: location.href.split('/')[5],
                            sex: $('#powermail_field_anrede').val(),
                            name: $('#powermail_field_vorname').val(),
                            surname: $('#powermail_field_nachname').val(),
                            patronymic: $('#powermail_field_Patronymic').val(),
                            date_of_birth: $('#powermail_field_geburtsdatum').val(),
                            phone: $('#powermail_field_telefonnummer').val(),
                            email: $('#powermail_field_e_mail').val(),
                            place_of_residence: $('#powermail_field_residence').val(),
                            blood_type: $('#powermail_field_blood').val(),
                        })
                    },
                    success: (data) => {
                        if ('errors' in data) {
                            toastr["error"]("Произошла ошибка! Повторите позже или обновите страницу.");
                        }
                        if ('success' in data) {
                            toastr["success"]("Пациент успешно добавлен");
                            document.querySelectorAll('.page_form input').forEach(item => {
                                item.value = '';
                            });
                            document.querySelectorAll('.page_form select').forEach(item => {
                                item.selectedIndex = 0;
                            });
                            setTimeout(() => location.reload(), 3000);
                        }
                    }
                })
            }
        });

        function validator() {
            const validateEmail = (email) => {
                return email.match(
                    /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                );
            };
            const validateFIO = (FIO) => {
                return FIO.value.trim().length !== 0;
            };

            let flags = true;
            let name = document.querySelector("#powermail_field_vorname");
            let surname = document.querySelector("#powermail_field_nachname");
            let patronymic = document.querySelector("#powermail_field_Patronymic");
            let phone = document.querySelector("#powermail_field_telefonnummer");
            let email = $('#powermail_field_e_mail').val();
            let date = document.querySelector("#powermail_field_geburtsdatum");
            let invalids = document.querySelectorAll(".invalid-feedback");

            invalids.forEach(item => {
                item.style.display = "none";
            });

            if (!validateEmail(email)) {
                document.querySelector("#invalid_email").style.display = "block";
                flags = false;
            }
            if (!validateFIO(name)) {
                document.querySelector("#invalid_name").style.display = "block";
                flags = false;
            }
            if (!validateFIO(surname)) {
                document.querySelector("#invalid_surname").style.display = "block";
                flags = false;
            }
            if (!validateFIO(patronymic)) {
                document.querySelector("#invalid_patronymic").style.display = "block";
                flags = false;
            }
            if (!validateFIO(phone)) {
                document.querySelector("#invalid_phone").style.display = "block";
                flags = false;
            }
            if (!validateFIO(date)) {
                document.querySelector("#invalid_date").style.display = "block";
                flags = false;
            }
            return flags;
        } // Валидатор

        let phone = document.querySelector("#powermail_field_telefonnummer");
        let brd = document.querySelector("#powermail_field_geburtsdatum");
        let name = document.querySelector("#powermail_field_vorname");
        let surname = document.querySelector("#powermail_field_nachname");
        let patronymic = document.querySelector("#powermail_field_Patronymic");

        phone.oninput = function () {
            phone.value = phone.value.replace(/[A-Za-zА-Яа-яЁё^!\-?=*+|`~_&%$#@"№;()]/, '');
        }
        brd.oninput = function () {
            brd.value = brd.value.replace(/[A-Za-zА-Яа-яЁё^!\?=*+|`~_&%$#@"№;()]/, '');
        }

        function oninputFIO(input) {
            input.oninput = function () {
                input.value = input.value.replace(/[0-9^!\?=*+|`~_&%$#@"№;()]/, '');
            }
        }

        oninputFIO(name);
        oninputFIO(surname);
        oninputFIO(patronymic);
    </script>
{% endblock %}